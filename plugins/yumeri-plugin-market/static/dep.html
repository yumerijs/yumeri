<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>依赖管理</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
h1 { margin-bottom: 10px; }
.scroll-container { overflow-x:auto; -webkit-overflow-scrolling: touch; }
table { width: 100%; border-collapse: collapse; min-width: 600px; margin-top: 10px; }
th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
th { background-color: #f0f0f0; }
select { width: 100%; }
button { margin: 10px 5px 10px 0; padding: 6px 12px; cursor: pointer; }
.status { margin-top: 10px; }
.changed-dot { display:inline-block; width:8px; height:8px; background:green; border-radius:50%; margin-right:5px; }
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; }
.modal-content { background:#fff; padding:20px; border-radius:6px; max-width:90%; }
.modal-buttons { margin-top:15px; text-align:right; }
.modal-buttons button { margin-left:10px; }
.add-input { width: 200px; padding: 4px; margin-right:5px; }
</style>
</head>
<body>

<h1>依赖管理</h1>
<div>
    <button id="saveBtn">保存更改</button>
    <input type="text" id="addName" class="add-input" placeholder="依赖名">
    <input type="text" id="addVer" class="add-input" placeholder="版本 (可留空)">
    <button id="addBtn">添加依赖</button>
</div>
<div class="status" id="status"></div>
<div class="scroll-container">
    <table>
      <thead>
        <tr>
          <th>依赖名</th>
          <th>当前版本</th>
          <th>可选版本</th>
        </tr>
      </thead>
      <tbody id="depsBody"></tbody>
    </table>
</div>

<div class="modal" id="confirmModal">
  <div class="modal-content">
    <h3>确认更改</h3>
    <div id="modalBody"></div>
    <div class="modal-buttons">
      <button id="modalCancel">取消</button>
      <button id="modalConfirm">确认</button>
    </div>
  </div>
</div>

<script>
const depsBody = document.getElementById('depsBody');
const statusEl = document.getElementById('status');
const saveBtn = document.getElementById('saveBtn');
const addBtn = document.getElementById('addBtn');
const addName = document.getElementById('addName');
const addVer = document.getElementById('addVer');
const modal = document.getElementById('confirmModal');
const modalBody = document.getElementById('modalBody');
const modalCancel = document.getElementById('modalCancel');
const modalConfirm = document.getElementById('modalConfirm');

let dependencies = []; // [{name, version, allVersions: [], changed:false}]

async function fetchDependencies() {
    const res = await fetch('/api/market/dependencies');
    const data = await res.json();
    if (data.success) {
        dependencies = data.dependencies.map(dep => ({ ...dep, allVersions: [], changed:false }));
        await fetchAllVersions();
        renderTable();
    } else {
        statusEl.textContent = '获取依赖失败: ' + data.message;
    }
}

async function fetchAllVersions() {
    for (let dep of dependencies) {
        try {
            const res = await fetch(`/api/market/versions?name=${encodeURIComponent(dep.name)}`);
            const data = await res.json();
            if (data && typeof data === 'object') {
                const versionKeys = Object.keys(data);
                // 如果当前版本不在列表里也加入
                if (!versionKeys.includes(dep.version)) versionKeys.unshift(dep.version);
                dep.allVersions = versionKeys;
            } else {
                dep.allVersions = [dep.version];
            }
        } catch (e) {
            dep.allVersions = [dep.version];
        }
    }
}

function renderTable() {
    depsBody.innerHTML = '';
    dependencies.forEach((dep, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${dep.changed?'<span class="changed-dot"></span>':''}${dep.name}</td>
            <td>${dep.version}</td>
            <td>
                <select>
                    ${dep.allVersions.map(v => `<option value="${v}" ${v===dep.version?'selected':''}>${v}</option>`).join('')}
                    <option value="__REMOVE__">移除依赖</option>
                </select>
            </td>
        `;
        const select = tr.querySelector('select');
        select.addEventListener('change', () => {
            if(select.value==='__REMOVE__'){
                dep.changed = true;
                dep.version = 'null'; // 标记卸载
            } else {
                dep.changed = select.value !== dep.version && dep.version!=='null';
                dep.version = select.value;
            }
            renderTable();
        });
        depsBody.appendChild(tr);
    });
}

// 添加依赖
addBtn.addEventListener('click', async () => {
    const name = addName.value.trim();
    const version = addVer.value.trim() || 'latest';
    if (!name) return;
    // 避免重复
    if (dependencies.find(d => d.name === name)) {
        alert('依赖已存在');
        return;
    }
    dependencies.push({ name, version, allVersions:[version], changed:true });
    renderTable();
    addName.value=''; addVer.value='';
});

// 保存更改，弹出模态框
saveBtn.addEventListener('click', () => {
    const changedDeps = dependencies.filter(d => d.changed);
    if (changedDeps.length===0) {
        statusEl.textContent='没有更改';
        return;
    }
    modalBody.innerHTML = '<ul>' + changedDeps.map(d=>`<li>${d.name}: ${d.version}</li>`).join('') + '</ul>';
    modal.style.display='flex';
});

modalCancel.addEventListener('click', ()=>{ modal.style.display='none'; });

modalConfirm.addEventListener('click', async () => {
    modal.style.display='none';
    const changedDeps = dependencies.filter(d => d.changed);
    const params = new URLSearchParams();
    params.set('deps', changedDeps.map(d=>`${d.name}@${d.version}`).join(','));
    statusEl.textContent='正在保存更改...';
    try {
        const res = await fetch('/api/market/savever?' + params.toString(), { method:'POST' });
        const data = await res.json();
        if (data.success) {
            statusEl.textContent=`已安装: ${data.installed.join(', ')}, 已移除: ${data.removed.join(', ')}`;
            await fetchDependencies();
        } else {
            statusEl.textContent='保存失败: '+data.message;
        }
    } catch(e){
        statusEl.textContent='请求失败: '+e.message;
    }
});

fetchDependencies();
</script>
</body>
</html>